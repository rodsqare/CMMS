// Prisma schema for CMMS (Computerized Maintenance Management System)
// Using PostgreSQL via Neon
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  // Force client regeneration for PostgreSQL
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id                Int      @id @default(autoincrement())
  nombre            String
  email             String   @unique
  password          String
  rol               String
  activo            Boolean  @default(true)
  ultimo_acceso     DateTime?
  intentos_fallidos Int      @default(0)
  bloqueado_hasta   DateTime?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Relaciones
  ordenesCreadas       OrdenTrabajo[]      @relation("OrdenCreador")
  ordenesAsignadas     OrdenTrabajo[]      @relation("OrdenTecnico")
  mantenimientosProgramados Mantenimiento[] @relation("MantenimientoCreador")
  mantenimientosRealizados  MantenimientoRealizado[] @relation("MantenimientoTecnico")
  notificaciones       Notificacion[]
  logs                 Log[]
  documentosCreados    Documento[]

  @@index([email])
  @@index([rol])
  @@map("usuarios")
}

model Equipo {
  id                   Int       @id @default(autoincrement())
  codigo               String    @unique
  nombre               String
  tipo                 String
  marca                String?
  modelo               String?
  numero_serie         String?
  ubicacion            String?
  fecha_adquisicion    DateTime?
  vida_util_anos       Int?
  valor_adquisicion    Decimal?
  estado               String
  criticidad           String
  descripcion          String?
  especificaciones     Json?
  ultima_mantencion    DateTime?
  proxima_mantencion   DateTime?
  horas_operacion      Decimal?
  created_at           DateTime  @default(now())
  updated_at           DateTime  @updatedAt

  // Relaciones
  ordenesTrabajo           OrdenTrabajo[]
  mantenimientos           Mantenimiento[]
  mantenimientosRealizados MantenimientoRealizado[]
  documentos               Documento[]

  @@index([codigo])
  @@index([estado])
  @@index([tipo])
  @@map("equipos")
}

model OrdenTrabajo {
  id                Int      @id @default(autoincrement())
  numero_orden      String   @unique
  equipo_id         Int
  tipo              String
  prioridad         String
  estado            String
  descripcion       String
  fecha_solicitud   DateTime @default(now())
  fecha_programada  DateTime?
  fecha_inicio      DateTime?
  fecha_finalizacion DateTime?
  tiempo_estimado   Int?
  tiempo_real       Int?
  costo_estimado    Decimal?
  costo_real        Decimal?
  creado_por        Int
  asignado_a        Int?
  notas             String?
  resultado         String?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Relaciones
  equipo       Equipo  @relation(fields: [equipo_id], references: [id], onDelete: Cascade)
  creador      Usuario @relation("OrdenCreador", fields: [creado_por], references: [id])
  tecnico      Usuario? @relation("OrdenTecnico", fields: [asignado_a], references: [id])
  documentos   Documento[]

  @@index([numero_orden])
  @@index([equipo_id])
  @@index([estado])
  @@index([prioridad])
  @@index([creado_por])
  @@index([asignado_a])
  @@map("ordenes_trabajo")
}

model Mantenimiento {
  id                     Int      @id @default(autoincrement())
  equipo_id              Int
  tipo                   String
  frecuencia             String
  frecuencia_dias        Int
  ultima_realizacion     DateTime?
  proxima_programada     DateTime
  descripcion            String
  procedimiento          String?
  tiempo_estimado        Int?
  activo                 Boolean  @default(true)
  creado_por             Int
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  // Relaciones
  equipo                  Equipo @relation(fields: [equipo_id], references: [id], onDelete: Cascade)
  creador                 Usuario @relation("MantenimientoCreador", fields: [creado_por], references: [id])
  realizaciones           MantenimientoRealizado[]

  @@index([equipo_id])
  @@index([proxima_programada])
  @@index([activo])
  @@map("mantenimientos")
}

model MantenimientoRealizado {
  id                 Int      @id @default(autoincrement())
  mantenimiento_id   Int
  equipo_id          Int
  fecha_realizacion  DateTime @default(now())
  realizado_por      Int
  tiempo_real        Int?
  costo              Decimal?
  observaciones      String?
  tareas_realizadas  Json?
  estado_equipo      String?
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  // Relaciones
  mantenimiento Mantenimiento @relation(fields: [mantenimiento_id], references: [id], onDelete: Cascade)
  equipo        Equipo @relation(fields: [equipo_id], references: [id], onDelete: Cascade)
  tecnico       Usuario @relation("MantenimientoTecnico", fields: [realizado_por], references: [id])

  @@index([mantenimiento_id])
  @@index([equipo_id])
  @@index([fecha_realizacion])
  @@map("mantenimientos_realizados")
}

model Documento {
  id            Int      @id @default(autoincrement())
  tipo          String
  nombre        String
  descripcion   String?
  ruta_archivo  String
  tipo_archivo  String
  tamano        Int
  equipo_id     Int?
  orden_id      Int?
  subido_por    Int
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Relaciones
  equipo   Equipo? @relation(fields: [equipo_id], references: [id], onDelete: Cascade)
  orden    OrdenTrabajo? @relation(fields: [orden_id], references: [id], onDelete: Cascade)
  usuario  Usuario @relation(fields: [subido_por], references: [id])

  @@index([equipo_id])
  @@index([orden_id])
  @@index([tipo])
  @@map("documentos")
}

model Notificacion {
  id         Int      @id @default(autoincrement())
  usuario_id Int
  tipo       String
  titulo     String
  mensaje    String
  leida      Boolean  @default(false)
  fecha_envio DateTime @default(now())
  datos      Json?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relaciones
  usuario Usuario @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@index([usuario_id])
  @@index([leida])
  @@index([tipo])
  @@map("notificaciones")
}

model Log {
  id         Int      @id @default(autoincrement())
  usuario_id Int?
  accion     String
  modulo     String
  descripcion String
  ip_address String?
  user_agent String?
  datos      Json?
  created_at DateTime @default(now())

  // Relaciones
  usuario Usuario? @relation(fields: [usuario_id], references: [id], onDelete: SetNull)

  @@index([usuario_id])
  @@index([accion])
  @@index([modulo])
  @@index([created_at])
  @@map("logs")
}

model Configuracion {
  id              Int      @id @default(autoincrement())
  clave           String   @unique
  valor           String?
  descripcion     String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@index([clave])
  @@map("configuracion")
}
